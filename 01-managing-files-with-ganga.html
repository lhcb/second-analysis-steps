<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>LHCb Starterkit: Second analysis steps</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="css/swc.css" />
    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css" />
    <meta charset="UTF-8" />
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
     ga('create', 'UA-63818884-1', 'auto');
     ga('send', 'pageview');
    </script>
  </head>
  <body class="lesson">
    <div class="container card">
      <div class="banner">
        <a href="https://lhcb.github.io/second-analysis-steps/">
          <img src="img/starterkit.png" height="200" alt="LHCb Starterkit">
        </a>
      </div>
      <div class="row">
        <div class="col-md-10 col-md-offset-1">
          <h1 class="title">Second analysis steps</h1>
          <h2 class="subtitle">Managing files in Ganga</h2>
<div id="learning-objectives" class="objectives panel panel-warning">
<div class="panel-heading">
<h2 id="learning-objectives" class="objectives panel panel-warning"><span class="glyphicon glyphicon-certificate"></span>Learning Objectives</h2>
</div>
<div class="panel-body">
<ul>
<li>Choose whether job output is saved locally or on the Grid</li>
<li>Choose where to look for job input files</li>
<li>Move files from any grid site to CERN, for analysis using EOS</li>
</ul>
</div>
</div>
<!--
Ganga - Tasks, DiracFile and LocalFile, alternative to MassStorageFile with 
replication to CERN
Dirac - Replicating to CERN for use with EOS
Dirac CLI - downloading LFNs, finding where an LFN is replicated, finding what 
grid sites are available
EOS - xrdfs local usage
-->
<p>Ganga allows you to define a job and have it run anywhere: on your local machine, on the <a href="http://information-technology.web.cern.ch/services/batch">batch system</a>, or on the Grid. This is very convenient as you don't need to worry about the specifics of each platform.</p>
<p>Ganga treats files in a similar way to jobs, in that you only need to change the object you're using to tell Ganga to use local files, files on the Grid, or files on EOS. In this lesson, we'll see how you can efficiently manage input and output files using Ganga.</p>
<div id="ganga-problems" class="callout panel panel-info">
<div class="panel-heading">
<h2 id="ganga-problems" class="callout panel panel-info"><span class="glyphicon glyphicon-pushpin"></span>Ganga problems</h2>
</div>
<div class="panel-body">
<p>Ganga is currently in a state of flux. It is changing regularly, and some things may begin or stop work between releases. The developers of Ganga are working to stabilise the application and its interface. This takes some time, and it helps to have users report the problems they see.</p>
<p>It's generally advised to use the latest available version of Ganga. If you encounter problems, you should first search <a href="https://groups.cern.ch/group/lhcb-distributed-analysis/default.aspx">the archives of the <code>lhcb-distributed-analysis</code> mailing list</a>. If you don't find an answer, you can talk to the Ganga developers directly on the <a href="https://github.com/ganga-devs/ganga">GitHub issues page for Ganga</a>, or by sending an email to <code>lhcb-distributed-analysis</code>.</p>
</div>
</div>
<div id="making-a-fresh-start" class="callout panel panel-info">
<div class="panel-heading">
<h2 id="making-a-fresh-start" class="callout panel panel-info"><span class="glyphicon glyphicon-pushpin"></span>Making a fresh start</h2>
</div>
<div class="panel-body">
<p>Throughout this lesson, we'll be using the most up-to-date version of Ganga that's available, v601r19. To make sure there will be no files from older versions of Ganga to interfere, we will move them to a backup location.</p>
<pre class="shell"><code>$ cd ~
$ mkdir ganga-backup
# See what&#39;s in your home directory that&#39;s related to Ganga
$ ls -la | grep -i ganga
# Then move everything
$ mv gangadir .gangarc* .ganga.log .ganga.py .ipython-ganga ganga-backup</code></pre>
<p>You can move this back after the lesson if you want to restore your old settings and data.</p>
</div>
</div>
<p>We'll be doing everything in Ganga, so let's start it up.</p>
<pre class="shell"><code>$ lb-run Ganga v601r19 ganga</code></pre>
<p>If it's your first time starting Ganga, you'll be asked if you want to create a default <code>.gangarc</code> file with the default settings.</p>
<blockquote>
<p>Would you like to create default config file <code>~/.gangarc</code> with standard settings ([y]/n) ?</p>
</blockquote>
<p>Answer with <code>y</code>. The <code>.gangarc</code> file defines the configuration of Ganga, and the defaults are normally good enough.</p>
<p>You'll then be dropped in a <a href="https://ipython.org/ipython-doc/3/interactive/tutorial.html">IPython shell</a>. We will create a job that runs a Python script that accepts a path to an input text file as an argument, and saves a file that contains the text of the file reversed. For example, it would save a file containing ‘!dlrow olleH’ if it was given a file containing ‘Hello world!’ as input.</p>
<p><a href="code/01-managing-files-with-ganga/reverse.py">Download the script</a> to lxplus and set it to be executable. You can execute these commands inside Ganga, if you like, by prefixing them with a <code>!</code>.</p>
<pre class="shell"><code>$ wget https://lhcb.github.io/second-analysis-steps/code/01-managing-files-with-ganga/reverse.py
$ chmod +x reverse.py
$ ./reverse.py
Usage: reverse.py &lt;file&gt;</code></pre>
<p>In Ganga, create a <code>Job</code> object with a descriptive name and take a look at it.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">j <span class="op">=</span> Job(name<span class="op">=</span><span class="st">&#39;Reverser&#39;</span>)
<span class="bu">print</span> j</code></pre></div>
<p>You'll see that Ganga has created a <code>Job</code> which will execute the <code>echo</code> command, passing the list of arguments <code>['Hello World']</code>. Each element of this list will be passed as a positional argument to the <code>echo</code> command.</p>
<p>We'll replace the command name and the arguments, so that our <code>reverse.py</code> script is run with a text file as input.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">j.application.exe <span class="op">=</span> File(<span class="st">&#39;reverse.py&#39;</span>)
j.application.args <span class="op">=</span> [File(<span class="st">&#39;input.txt&#39;</span>)]</code></pre></div>
<p>We haven't made <code>input.txt</code>, so let's make it by executing a couple of shell commands inside Ganga.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="op">!</span>echo <span class="op">-</span>e <span class="st">&#39;Hello world!</span><span class="ch">\n</span><span class="st">This is the second line.&#39;</span> <span class="op">&gt;</span> <span class="bu">input</span>.txt
<span class="op">!</span>cat <span class="bu">input</span>.txt</code></pre></div>
<p>Before submission, we just need to tell Ganga what to do with the output. The script saves the output to a file called like the input, but with <code>-reversed</code> appended before the file extension (<code>.txt</code> in this case), so we tell Ganga explicitly to move this file to the local job output directory.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">j.outputfiles <span class="op">=</span> [LocalFile(<span class="st">&#39;input-reversed.txt&#39;</span>)]</code></pre></div>
<p>Now we can submit the job.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">j.submit()</code></pre></div>
<p>By default, jobs run on the machine you're running Ganga on, as their <code>backend</code> property is set to an instance of the <code>Local</code> backend.</p>
<p>The job will finish very quickly, and we can inspect the output files.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">j.peek()
j.peek(<span class="st">&#39;input-reversed.txt&#39;</span>)</code></pre></div>
<p>There are a couple of file-related things to take note of in what we just did:</p>
<ol style="list-style-type: decimal">
<li>The <code>File</code> object is used to define local files that should be available in the ‘working directory’ of the job (wherever it executes). We need both the script and the input text file to be in the working directory, so both of the paths to the files on our local machine are wrapped in <code>File</code>.</li>
<li>The <code>LocalFile</code> object is used to define what files in the working directory of the job should be saved in the local job output directory, in this case the file with <code>-reversed</code> in it.</li>
</ol>
<p>Note that there are several files in the job output directory, seen with <code>j.peek()</code>, that we didn't explicitly ask for, most notably <code>stdout</code> and <code>stderr</code>. These two files are essentially the logs of the job, and Ganga always saves them in the local job output directory as they're almost always useful.<br />
For Gaudi jobs, Ganga will also automatically download the <code>summary.xml</code> file, which contains useful information about algorithm counters.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">df <span class="op">=</span> DiracFile(<span class="st">&#39;input.txt&#39;</span>, localDir<span class="op">=</span><span class="st">&#39;.&#39;</span>)
df.put(uploadSE<span class="op">=</span><span class="st">&#39;CERN-USER&#39;</span>)
<span class="bu">print</span> df.lfn</code></pre></div>
<p>Grid files that are replicated at CERN are directly accessible via EOS. We can see that our file's on EOS by looking at the LFN Ganga gave us. We just need to add the prefix <code>/eos/lhcb/grid/user</code> to the LFN.</p>
<pre class="shell"><code>eos ls /eos/lhcb/grid/user//lhcb/user/a/apearce/GangaFiles_22.24_Wednesday_18_May_2016</code></pre>
<div id="using-massstoragefile" class="callout panel panel-info">
<div class="panel-heading">
<h2 id="using-massstoragefile" class="callout panel panel-info"><span class="glyphicon glyphicon-pushpin"></span>Using MassStorageFile</h2>
</div>
<div class="panel-body">
<p>The <code>MassStorageFile</code> object uploads job output directly to EOS. However, using <code>MassStorageFile</code> for this purpose is actively discouraged by the Ganga developers as it is highly inefficient: a file made on the Grid will first be downloaded to the machine running Ganga, and then uploaded to EOS.</p>
<p>Instead, always use <code>DiracFile</code> for large outputs, and then replicate them to <code>CERN-USER</code> if you want to be able to access them on EOS.</p>
</div>
</div>
<p>If you have any <code>DiracFile</code>, you can ask for it to be replicated to a grid site it's not currently available at.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">df.replicate(<span class="st">&#39;CERN-USER&#39;</span>)</code></pre></div>
<div id="automating-replication-to-cern" class="callout panel panel-info">
<div class="panel-heading">
<h2 id="automating-replication-to-cern" class="callout panel panel-info"><span class="glyphicon glyphicon-pushpin"></span>Automating replication to CERN</h2>
</div>
<div class="panel-body">
<p>If you have a job with subjobs, you can automate this to replicate all output files to CERN, so that you can run your analysis directly on the files on EOS.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">j <span class="op">=</span> jobs(...)
<span class="cf">for</span> sj <span class="op">in</span> j.subjobs:
  <span class="co"># Get all output files which are DiracFile objects</span>
  <span class="cf">for</span> df <span class="op">in</span> sj.outputfiles.get(DiracFile):
    <span class="co"># No need to replicate if it&#39;s already at CERN</span>
    <span class="cf">if</span> <span class="st">&#39;CERN-USER&#39;</span> <span class="op">not</span> <span class="op">in</span> df.locations:
      df.replicate(<span class="st">&#39;CERN-USER&#39;</span>)</code></pre></div>
<p>You could make a function from this and put it in your <code>.ganga.py</code> file, whose contents is available in any Ganga session.</p>
</div>
</div>
<p>You can download a <code>DiracFile</code> locally using the <code>get</code> method. If you already know an LFN, you can use this to quickly download it locally to play around with it. All you need to do is prefix the LFN with <code>LFN:</code>, and Ganga will assume that the file already exists on the Grid somewhere (whereas before it assumed the file was local).</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">df2 <span class="op">=</span> DiracFile(<span class="st">&#39;LFN:&#39;</span> <span class="op">+</span> df.lfn)
<span class="co"># The directory used for the download must exist first</span>
<span class="op">!</span>mkdir foo
dfr2.get(localPath<span class="op">=</span><span class="st">&#39;foo&#39;</span>)
<span class="op">!</span>cat foo<span class="op">/</span><span class="bu">input</span>.txt</code></pre></div>
<p>We can tell Ganga to upload the job output to the Grid automatically.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># Clone the job</span>
j2 <span class="op">=</span> Job(j)
j2.outputfiles <span class="op">=</span> [DiracFile(<span class="st">&#39;*-reversed.txt&#39;</span>)]
j2.submit()</code></pre></div>
<p>Here we use a ‘pattern’ to tell Ganga that any file ending in <code>*-reversed.txt</code> should be uploaded to Grid storage. Both <code>DiracFile</code> and <code>LocalFile</code> support these patterns.</p>
<p>To download the output, we use <code>.get</code> as usual.</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">j2.outputfiles.get(DiracFile)[<span class="dv">0</span>].get(localPath<span class="op">=</span><span class="st">&#39;.&#39;</span>)</code></pre></div>
<div id="using-ganga-v600r44" class="callout panel panel-info">
<div class="panel-heading">
<h2 id="using-ganga-v600r44" class="callout panel panel-info"><span class="glyphicon glyphicon-pushpin"></span>Using Ganga v600r44</h2>
</div>
<div class="panel-body">
<p>Using <code>DiracFile</code> with the <code>Local</code> backend doesn't work with Ganga v601r19. You can try again with Ganga v600r44, that happens to work in this instance, with the following commands:</p>
<pre class="shell"><code>$ export CMTCONFIG=x86_64-slc6-gcc48-opt
$ LbLogin
$ SetupProject Ganga v600r44
$ ganga</code></pre>
</div>
</div>
<p>Being able to manipulate files with Ganga can be very useful. Particularly for Gaudi-based jobs where:</p>
<ol style="list-style-type: decimal">
<li>We often specify large sets of <code>DiracFiles</code> as input, from the bookkeeping, but often want to download a file or two locally when testing options;</li>
<li>We want to duplicate a large number of output LFNs to <code>CERN-USER</code> so that we can use them directly with EOS and XRootD commands;</li>
<li>We want to job output to be download locally automatically when the job completes.</li>
</ol>
<div id="defining-inputfiles" class="callout panel panel-info">
<div class="panel-heading">
<h2 id="defining-inputfiles" class="callout panel panel-info"><span class="glyphicon glyphicon-pushpin"></span>Defining inputfiles</h2>
</div>
<div class="panel-body">
<p>The <code>inputfiles</code> attribute of a <code>Job</code> object works in a similar way to <code>outputfile</code>. In our example, the reverser script that the <code>Executable</code> application uses doesn't know how to handle things specified as <code>inputdata</code>, so we had to use <code>File</code> when defining the arguments.</p>
<p>For LHCb applications, you will almost always define the <code>inputdata</code> list using either <code>LocalFile</code> or <code>DiracFile</code> objects. Which one you will use just depends on where the input files are.</p>
</div>
</div>
        </div>
      </div>
      <div class="footer">
        <a class="label swc-blue-bg" href="https://lhcb.github.io/lhcb/starterkit">Starterkit</a>
        <a class="label swc-blue-bg" href="https://github.com/lhcb/second-analysis-steps">Source</a>
        <a class="label swc-blue-bg" href="mailto:lhcb-starterkit@cern.ch">Contact</a>
      </div>
    </div>
    <!-- Javascript placed at the end of the document so the pages load faster -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="css/bootstrap/bootstrap-js/bootstrap.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/contrib/auto-render.min.js"></script>
    <script>
      // Go KaTeX go!
      renderMathInElement(document.body);
    </script>
  </body>
</html>
