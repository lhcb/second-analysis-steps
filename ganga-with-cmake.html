<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>LHCb Starterkit: Second analysis steps</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="css/swc.css" />
    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css" />
    <meta charset="UTF-8" />
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
     ga('create', 'UA-63818884-1', 'auto');
     ga('send', 'pageview');
    </script>
  </head>
  <body class="lesson">
    <div class="container card">
      <div class="banner">
        <a href="https://lhcb.github.io/second-analysis-steps/">
          <img src="img/starterkit.png" height="100" alt="LHCb Starterkit">
        </a>
      </div>
      <div class="row">
        <div class="col-md-10 col-md-offset-1">
          <h1 class="title">Second analysis steps</h1>
          <h2 class="subtitle">Using Ganga with local projects</h2>
<div id="learning-objectives" class="objectives panel panel-warning">
<div class="panel-heading">
<h2 id="learning-objectives" class="objectives panel panel-warning"><span class="glyphicon glyphicon-certificate"></span>Learning Objectives</h2>
</div>
<div class="panel-body">
<ul>
<li>Submit jobs using Ganga that use local LHCb projects containing your own modifications</li>
</ul>
</div>
</div>
<p>Before starting, you should read the <a href="01-managing-files-with-ganga.html">first Ganga lesson</a>, which gives some advice about choosing a Ganga version, making a clean environment for running Ganga in, and where to go to get help when things in Ganga go wrong.</p>
<div id="how-things-used-to-be" class="callout panel panel-info">
<div class="panel-heading">
<h2 id="how-things-used-to-be" class="callout panel panel-info"><span class="glyphicon glyphicon-pushpin"></span>How things used to be</h2>
</div>
<div class="panel-body">
<p>Before <code>lb-dev</code> was available, local projects would conventionally live in the <code>~/cmtuser</code> folder. A local DaVinci v36r5 project, for example, would be at <code>~/cmtuser/DaVinci_v36r5</code>, within which one could checkout sub-packages, edit them, and compile the main package. Running things like <code>gaudirun.py</code> would then pick up the local version of DaVinci, similarly to how the <code>./run</code> command does things today.</p>
<p>Ganga now supports lb-dev packages, so the <code>SetupProject</code> style of use is deprecated as of version 6.2, and will quickly become unsupported.</p>
</div>
</div>
<p>We will create a local version of DaVinci with some modified algorithm, so that we can check that Ganga is using the local version when we submit a job. First, we'll create a local DaVinci with <code>lb-dev</code>, and will then fetch the [<code>DecayTreeTuple</code>][dtt-package], which lives under the <code>Phys</code> hat.</p>
<pre class="shell"><code>$ lb-dev DaVinci v41r2p1
$ cd DaVinciDev_v41r2p1
$ git lb-use Analysis
$ git lb-checkout Analysis/v17r3 Phys/DecayTreeTuple</code></pre>
<p>We will do something silly as a test: add a <code>_2M</code> branch to <code>TupleToolKinematic</code> that fills twice the invariant mass of the particle. To do this, we just need to edit the implementation file at <code>src/TupleToolKinematic.cpp</code>. Line 76 of that file reads like this:</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp">test &amp;= tuple-&gt;column( prefix+<span class="st">&quot;_M&quot;</span>, P-&gt;momentum().M() );</code></pre></div>
<p>Here, <code>tuple</code> is a object representing the ntuple to be filled, and the <code>column</code> method tells the ntuple to fill the branch named by the first argument (a <code>string</code>) with the value of the second argument. Create a line just below this one, using <code>_2M</code> as the branch name suffix as twice the particle mass as the value.</p>
<div class="sourceCode"><pre class="sourceCode cpp"><code class="sourceCode cpp">test &amp;= tuple-&gt;column( prefix+<span class="st">&quot;_2M&quot;</span>, <span class="dv">2</span>*P-&gt;momentum().M() );</code></pre></div>
<p>Then we just need to compile our local DaVinci package. You must be in the <code>DaVinci_v40r1p3</code> when executing the following commands:</p>
<pre class="shell"><code># Using -j8 runs up to 8 tasks in parallel, speeding up the build
$ make -j8
$ make install</code></pre>
<p>This will create a folder called <code>InstallArea</code>. This is the folder that Ganga will provide on the Grid.</p>
<p>Now we can proceed as usual, defining a job running DaVinci in Ganga. But instead of using the built in version of our app (<code>DaVinci()</code>), we will use <code>GaudiExec()</code> to make a custom application:</p>
<pre class="shell"><code>$ lb-run Ganga v602r2 ganga</code></pre>
<pre><code>j = Job(name=&#39;Local_DaVinci_Test&#39;)
myApp = GaudiExec()
myApp.directory = &quot;/path/to/DaVinciDev_v41r2p1&quot;
myApp.options = [&quot;/path/to/DaVinciDev_v41r2p1/myOptions.py&quot;]
j.application = myApp
j.inputdata = [...]
j.outputfiles = [LocalFile(&#39;*.root&#39;)]
j.submit()</code></pre>
<div id="details-of-gaudiexec" class="callout panel panel-info">
<div class="panel-heading">
<h2 id="details-of-gaudiexec" class="callout panel panel-info"><span class="glyphicon glyphicon-pushpin"></span>Details of GaudiExec</h2>
</div>
<div class="panel-body">
<p>Here, <code>.options</code> is a list of arguments that are passed to <code>gaudirun.py</code>. The actual command looks like:</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash">$ <span class="ex">./run</span> gaudirun.py [options contents] [inputdata contents]</code></pre></div>
<p>If you want to run a program directly without the <code>gaudirun.py</code> script, you can add <code>j.application.useGaudiRun = False</code>.</p>
<p>For more info, do <code>help(GaudiExec)</code> in Ganga.</p>
</div>
</div>
<p>After running this job, confirm that you have a <code>_2M</code> branch in your output ROOT file.</p>
<div id="you-know-what-to-do" class="challenge panel panel-success">
<div class="panel-heading">
<h2 id="you-know-what-to-do" class="challenge panel panel-success"><span class="glyphicon glyphicon-pencil"></span>You know what to do</h2>
</div>
<div class="panel-body">
<p>To test this, we need an options file that defines a <code>DecayTreeTuple</code>, and some data to run over. You know how to write options files so you can do this yourself. You could re-use an options file that we made previously, and use the same data.</p>
</div>
</div>
        </div>
      </div>
      <div class="footer">
        <a class="label swc-blue-bg" href="http://software-carpentry.org">Software Carpentry</a>
        <a class="label swc-blue-bg" href="https://github.com/lhcb/second-analysis-steps">Source</a>
        <a class="label swc-blue-bg" href="mailto:lhcb-starterkit@cern.ch">Contact</a>
        <a class="label swc-blue-bg" href="LICENSE.html">License</a>
      </div>
    </div>
    <!-- Javascript placed at the end of the document so the pages load faster -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="css/bootstrap/bootstrap-js/bootstrap.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/contrib/auto-render.min.js"></script>
    <script>
      // Go KaTeX go!
      renderMathInElement(document.body);
    </script>
  </body>
</html>
