<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>LHCb Starterkit: Second analysis steps</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="css/swc.css" />
    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css" />
    <meta charset="UTF-8" />
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
     ga('create', 'UA-63818884-1', 'auto');
     ga('send', 'pageview');
    </script>
  </head>
  <body class="lesson">
    <div class="container card">
      <div class="banner">
        <a href="https://lhcb.github.io/second-analysis-steps/">
          <img src="img/starterkit.png" height="100" alt="LHCb Starterkit">
        </a>
      </div>
      <div class="row">
        <div class="col-md-10 col-md-offset-1">
          <h1 class="title">Second analysis steps</h1>
          <h2 class="subtitle">Run a different stripping line on simulated data</h2>
<div id="learning-objectives" class="objectives panel panel-warning">
<div class="panel-heading">
<h2 id="learning-objectives" class="objectives panel panel-warning"><span class="glyphicon glyphicon-certificate"></span>Learning Objectives</h2>
</div>
<div class="panel-body">
<ul>
<li>Modify the minimal DecayTreeTuple example to apply a different stripping version to an MC sample</li>
</ul>
</div>
</div>
<p>Ideally, our simulated samples should feature the same stripping cuts as the real data we want to work with. We can be sure of this if the same stripping version has been used when processing the simulated and real data.</p>
<p>But often, our simulated sample will have a different version of the stripping applied to it. For example, what if our data sample uses Stripping 21, while our MC sample uses Stripping 20?</p>
<p>In this case, we simply need to rerun our stripping line of choice from the correct stripping version with one caveat: the decisions of the stripping that ran during the central MC production are placed in a default location in the TES (<code>/Event/Strip/Phys/DecReports</code>), so if we try to run our custom stripping it will complain because the location it wants to write the new decisions to already exists. To solve this issue, we need to run an instance of <code>EventNodeKiller</code> to remove the decisions from the MC production so that our custom stripping can write there instead. This is nice, because most tools expect to read the stripping decisions from the default location, so we won't have to reconfigure anything.</p>
<p><a href="code/14-rerun-stripping/options.py">This example</a> is an extended version of the <a href="http://lhcb.github.io/first-analysis-steps/minimal-dv-job.html">minimal DaVinci DecayTreeTuple job</a> that additionally runs the corresponding stripping line from Stripping 21.</p>
<p>Take a look at the file and try to find out what has changed compared to the <a href="code/09-minimal-dv/ntuple_options.py">minimal DaVinci example</a>.</p>
<p>The key changes are</p>
<ul>
<li>Removing the old stripping reports with a node killer</li>
</ul>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">from</span> Configurables <span class="im">import</span> EventNodeKiller
event_node_killer <span class="op">=</span> EventNodeKiller(<span class="st">&#39;StripKiller&#39;</span>)
event_node_killer.Nodes <span class="op">=</span> [<span class="st">&#39;/Event/AllStreams&#39;</span>, <span class="st">&#39;/Event/Strip&#39;</span>]</code></pre></div>
<ul>
<li>Picking the right stripping line from Stripping 21 (which we prepare with <code>buildStreams</code>):</li>
<li>Building a custom stream that only contains the desired stripping line</li>
</ul>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">strip <span class="op">=</span> <span class="st">&#39;stripping21&#39;</span>
streams <span class="op">=</span> buildStreams(stripping<span class="op">=</span>strippingConfiguration(strip),
                       archive<span class="op">=</span>strippingArchive(strip))

custom_stream <span class="op">=</span> StrippingStream(<span class="st">&#39;CustomStream&#39;</span>)
custom_line <span class="op">=</span> <span class="st">&#39;StrippingD2hhCompleteEventPromptDst2D2RSLine&#39;</span>

<span class="cf">for</span> stream <span class="kw">in</span> streams:
    <span class="cf">for</span> line <span class="kw">in</span> stream.lines:
        <span class="cf">if</span> line.name() <span class="op">==</span> custom_line:
            custom_stream.appendLines([line])</code></pre></div>
<ul>
<li>Instantiating a <code>StrippingConf</code> for running the stripping</li>
</ul>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">sc <span class="op">=</span> StrippingConf(Streams<span class="op">=</span>[custom_stream],
                   MaxCandidates<span class="op">=</span><span class="dv">2000</span>,
                   AcceptBadEvents<span class="op">=</span><span class="va">False</span>,
                   BadEventSelection<span class="op">=</span>filterBadEvents)</code></pre></div>
<ul>
<li>Inserting the node killer and the stripping selection sequence into the Gaudi sequence</li>
</ul>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">DaVinci().appendToMainSequence([event_node_killer, sc.sequence()])</code></pre></div>
        </div>
      </div>
      <div class="footer">
        <a class="label swc-blue-bg" href="http://software-carpentry.org">Software Carpentry</a>
        <a class="label swc-blue-bg" href="https://github.com/lhcb/second-analysis-steps">Source</a>
        <a class="label swc-blue-bg" href="mailto:lhcb-starterkit@cern.ch">Contact</a>
        <a class="label swc-blue-bg" href="LICENSE.html">License</a>
      </div>
    </div>
    <!-- Javascript placed at the end of the document so the pages load faster -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="css/bootstrap/bootstrap-js/bootstrap.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/contrib/auto-render.min.js"></script>
    <script>
      // Go KaTeX go!
      renderMathInElement(document.body);
    </script>
  </body>
</html>
