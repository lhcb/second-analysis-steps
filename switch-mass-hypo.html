<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>LHCb Starterkit: Seconds steps in LHCb</title>
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="css/bootstrap/bootstrap-theme.css" />
    <link rel="stylesheet" type="text/css" href="css/swc.css" />
    <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css" />
    <meta charset="UTF-8" />
    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <script>
     (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
     ga('create', 'UA-63818884-1', 'auto');
     ga('send', 'pageview');
    </script>
  </head>
  <body class="lesson">
    <div class="container card">
      <div class="banner">
        <a href="https://lhcb.github.io/second-analysis-steps/">
          <img src="img/starterkit.png" height="100" alt="LHCb Starterkit">
        </a>
      </div>
      <div class="row">
        <div class="col-md-10 col-md-offset-1">
          <h1 class="title">Seconds steps in LHCb</h1>
          <h2 class="subtitle">Replace a mass hypothesis</h2>
<div id="learning-objectives" class="objectives panel panel-warning">
<div class="panel-heading">
<h2 id="learning-objectives" class="objectives panel panel-warning"><span class="glyphicon glyphicon-certificate"></span>Learning Objectives</h2>
</div>
<div class="panel-body">
<ul>
<li>Create a new selection starting from the stripping line output</li>
<li>Change the particle hypothesis made by the stripping line</li>
</ul>
</div>
</div>
<p>There are many situations where you want to repurpose a stripping line to look for a new decay that is similar in topology but distinct from what was put into the stripping line. The easiest thing to do is to change some of the hypothesis on particle IDs made in the stripping. This lesson will show you how to do that.</p>
<div id="reinterpreting-stripping-selections" class="callout panel panel-info">
<div class="panel-heading">
<h2 id="reinterpreting-stripping-selections" class="callout panel panel-info"><span class="glyphicon glyphicon-pushpin"></span>Reinterpreting stripping selections</h2>
</div>
<div class="panel-body">
<p>Note that with this method you can never find more candidates than the stripping has already found. However, you can reinterpret parts of the decay to look for new decay modes.</p>
</div>
</div>
<p>As an example we will switch the decay of the D0 from (K pi) to (pi pi).</p>
<p>There is an algorithm that allows us to replace parts of the decay descriptor called <code>SubstitutePID</code>:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># configure an algorithm to substitute the Kaon in the D0-decay by a second pion </span>
<span class="im">from</span> Configurables <span class="im">import</span> SubstitutePID
subs <span class="op">=</span> SubstitutePID(
    <span class="st">&#39;MakeD02pipi&#39;</span>,
    Code <span class="op">=</span> <span class="st">&quot;DECTREE(&#39;[D*(2010)+ -&gt; (D0 -&gt; K- pi+) pi+]CC&#39;)&quot;</span>,
    <span class="co"># note that SubstitutePID can&#39;t handle automatic CC</span>
    Substitutions <span class="op">=</span> {
        <span class="st">&#39;Charm -&gt; (D0 -&gt; ^K- pi+) Meson&#39;</span>: <span class="st">&#39;pi-&#39;</span>,
        <span class="st">&#39;Charm -&gt; (D0 -&gt; ^K+ pi-) Meson&#39;</span>: <span class="st">&#39;pi+&#39;</span>
    }
)</code></pre></div>
<p>The algorithm is configured with a name <code>MakeD02pipi</code>. In the <code>Code</code> argument we need to specify the initial selection. This is done by using LoKi functors. Since we know we will be using an already prepared selection, we can simply use the <code>DECTREE</code> functor to search for candidates fulfilling this decay structure. See the <a href="http://lhcb.github.io/first-analysis-steps/loki-functors.html">lesson on LoKi</a> for more info on what you can do here.</p>
<p>Now we ware ready to specify which hypotheses to change. <code>Substitutions</code> is a dictionary where the keys are decay descriptors and the values are the names of the replacement particles. The particle that should be replaced is marked with a <code>^</code>. So in the example above</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co">&#39;Charm -&gt; (D0 -&gt; ^K- pi+) Meson&#39;</span>: <span class="st">&#39;pi-&#39;</span></code></pre></div>
<p>means: Look for a decay of a Charm-particle into D0 plus any meson, where the D0 decays to (K- pi+) and replace the K- with a pi-.</p>
<p>Note that <code>SubstitutePID</code> does not automatically handle complex conjugation via the <code>CC</code> operator. Therefore you have to specify all substitutions explicitely.</p>
<p>Next we have to handle the input and output of this algorithm. This is accomplished using <a href="https://twiki.cern.ch/twiki/bin/view/LHCb/ParticleSelection">particle selections</a>. The input to our substitution algorithm will be the candidates produced by the stripping. In order to make them look like a selection we can use the <code>DataOnDemand</code> service:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">from</span> PhysSelPython.Wrappers <span class="im">import</span> Selection
<span class="im">from</span> PhysSelPython.Wrappers <span class="im">import</span> SelectionSequence
<span class="im">from</span> PhysSelPython.Wrappers <span class="im">import</span> DataOnDemand

<span class="co"># Stream and stripping line we want to use</span>
stream <span class="op">=</span> <span class="st">&#39;AllStreams&#39;</span>
line <span class="op">=</span> <span class="st">&#39;D2hhCompleteEventPromptDst2D2RSLine&#39;</span>
tesLoc <span class="op">=</span> <span class="st">&#39;/Event/</span><span class="sc">{0}</span><span class="st">/Phys/</span><span class="sc">{1}</span><span class="st">/Particles&#39;</span>.<span class="bu">format</span>(stream, line)

<span class="co"># get the selection(s) created by the stripping</span>
strippingSels <span class="op">=</span> [DataOnDemand(Location<span class="op">=</span>tesLoc)]</code></pre></div>
<p>The output of the algorithm has to be packaged into a new selection:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># create a selection using the substitution algorithm</span>
selSub <span class="op">=</span> Selection(
    <span class="st">&#39;Dst2D0pi_D02pipi_Sel&#39;</span>,
    Algorithm<span class="op">=</span>Subs,
    RequiredSelections<span class="op">=</span>strippingSels
)</code></pre></div>
<p>Note how the input stripping selection is daisy-chained to the output selection through the <code>RequiredSelections</code> (it has to be a list of selections) argument. The new selection is added into a <code>SelectionSequnce</code> for further use by DaVinci:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python">selSeq <span class="op">=</span> SelectionSequence(<span class="st">&#39;SelSeq&#39;</span>, TopSelection<span class="op">=</span>selSub)</code></pre></div>
<p>We are now ready to produce an ntuple on our newly created selection. As usual we configure a <code>DecayTreeTuple</code>, which now is looking for the candidates, which have the redefined D0 decay:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># Create an ntuple to capture D*+ decays from the new selection</span>
dtt <span class="op">=</span> DecayTreeTuple(<span class="st">&#39;TupleDstToD0pi_D0Topipi&#39;</span>)
dtt.Inputs <span class="op">=</span> [selSeq.outputLocation()]
<span class="co"># note the redefined decay of the D0</span>
dtt.Decay <span class="op">=</span> <span class="st">&#39;[D*(2010)+ -&gt; ^(D0 -&gt; ^pi- ^pi+) ^pi+]CC&#39;</span></code></pre></div>
<p>The input to the <code>DecayTreeTuple</code> is taken as the <code>outputLocations</code> of the <code>SelectionSequence</code> we just created.</p>
<div id="why-use-davinci-selections" class="callout panel panel-info">
<div class="panel-heading">
<h2 id="why-use-davinci-selections" class="callout panel panel-info"><span class="glyphicon glyphicon-pushpin"></span>Why use DaVinci selections?</h2>
</div>
<div class="panel-body">
<p>Selections and SelectionSequences are an elegant way to organize the required algorithms that perform the job of selecting data. The <a href="https://twiki.cern.ch/twiki/bin/view/LHCb/ParticleSelection">particle selection toolkit</a> uses python tricks to make the management of even complicated sequences of selections rather straight forward. In particular the toolkit ensures that all necessary algorithms are run in the correct order to produce the desired selections. It is therfore mainly a tool to manage dependencies. For technical details have a look at the <a href="https://twiki.cern.ch/twiki/bin/view/LHCb/ParticleSelection">TWiki page</a>.</p>
</div>
</div>
<p>Finally we add the <code>SelectionSequence</code> and the <code>DecayTreeTuple</code> to the DaVinci application. Since we are adding more than one algorithm we need a <code>GaudiSequencer</code> that takes care of calling everything in the right order:</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="co"># add our new selection and the tuple into the sequencer</span>
seq <span class="op">=</span> GaudiSequencer(<span class="st">&#39;MyTupleSeq&#39;</span>)
seq.Members <span class="op">+=</span> [selSeq.sequence()]
seq.Members <span class="op">+=</span> [dtt]
DaVinci().appendToMainSequence([seq])</code></pre></div>
<p>The solution to this exercise <code>ntuple_switchHypo.py</code>, is <a href="./code/18-switch-mass-hypo/ntuple_switchHypo.py">available here</a>.</p>
<div id="think-about-it" class="callout panel panel-info">
<div class="panel-heading">
<h2 id="think-about-it" class="callout panel panel-info"><span class="glyphicon glyphicon-pushpin"></span>Think about it</h2>
</div>
<div class="panel-body">
<p>Why can't we use this method to look for D* decaying to D0+photon ?</p>
</div>
</div>
        </div>
      </div>
      <div class="footer">
        <a class="label swc-blue-bg" href="http://software-carpentry.org">Software Carpentry</a>
        <a class="label swc-blue-bg" href="https://github.com/lhcb/second-analysis-steps">Source</a>
        <a class="label swc-blue-bg" href="mailto:lhcb-starterkit@cern.ch">Contact</a>
        <a class="label swc-blue-bg" href="LICENSE.html">License</a>
      </div>
    </div>
    <!-- Javascript placed at the end of the document so the pages load faster -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="css/bootstrap/bootstrap-js/bootstrap.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/contrib/auto-render.min.js"></script>
    <script>
      // Go KaTeX go!
      renderMathInElement(document.body);
    </script>
  </body>
</html>
